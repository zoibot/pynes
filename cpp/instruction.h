#ifndef INSTRUCTION_H
#define INSTRUCTION_H

#include "util.h"

#include <string>
#include <iomanip>

using namespace std;

class Machine;

enum Op { BRK, ORA, ASL, SLO, PHP, ASL_A, NOP, BPL, CLC, JSR, AND, RLA, TSX, 
			  BIT, ROL, PLP, ROL_A, BMI, SEC, RTI, EOR, SRE, PHA, LSR, PLA,
			  LSR_A, JMP, BVC, CLI, RTS, ADC, ROR_A, BVS, RRA, SEI, ROR,
			  STA, SAX, STY, STX, DEY, DEX, TXA, BCC, TYA, TXS, LDY, LDA, 
			  LDX, LAX, TAY, TAX, BCS, CLV, CPY, CPX, CMP, DEC, DCP, INY,
			  INX, BNE, CLD, SBC, ISB, INC, BEQ, SED, DOP, AAC, ASR, ARR,
			  ATX, AXS, TOP, SYA, KIL, XAA, AXA, XAS, SXA, LAR };
const char opnames[][4] = { "BRK", "ORA", "ASL", "SLO", "PHP", "ASL", "NOP", "BPL", "CLC", 
					"JSR", "AND", "RLA", "TSX", "BIT", "ROL", "PLP", "ROL", "BMI",
					"SEC", "RTI", "EOR", "SRE", "PHA", "LSR", "PLA", "LSR", "JMP",
					"BVC", "CLI", "RTS", "ADC", "ROR", "BVS", "RRA", "SEI", "ROR",
					"STA", "SAX", "STY", "STX", "DEY", "DEX", "TXA", "BCC", "TYA",
					"TXS", "LDY", "LDA", "LDX", "LAX", "TAY", "TAX", "BCS", "CLV",
					"CPY", "CPX", "CMP", "DEC", "DCP", "INY", "INX", "BNE", "CLD",
					"SBC", "ISB", "INC", "BEQ", "SED", "DOP", "AAC", "ASR", "ARR",
					"ATX", "AXS", "TOP", "SYA", "KIL", "XAA", "AXA", "XAS", "SXA", 
					"LAR" };
enum AddrMode { IMP, IMM, ZP, ABS, REL, A, IXID, IDIX, ABSI, ABSY, ABSX, ZPX, ZPY, ZP_ST, ABS_ST};

struct Opcode {
	//byte opcode
	int cycles;
	Op op;
	AddrMode addr_mode;
	bool illegal;
	bool invalid;
	bool store;
    int extra_page_cross;

	Opcode();
	Opcode(Op op, AddrMode amode, int cycles);
	Opcode(Op op, AddrMode amode, int cycles, bool illegal);
	Opcode(Op op, AddrMode amode, int cycles, int extra_page_cross);
};

struct Instruction {
	Instruction();
    void next_instruction();
    Machine *mach;
	friend ostream& operator <<(ostream &out, Instruction &inst);

    byte opcode;
	Opcode op;
	int extra_cycles;
    byte operand;
	word addr, i_addr;
	byte args[2];
	byte arglen;
};

static const Opcode ops[256] = 
{ 
Opcode(BRK, IMP, 7),
Opcode(ORA, IXID, 6),
Opcode(KIL, IMP, 0),
Opcode(SLO, IXID, 8),
Opcode(NOP, ZP, 3),
Opcode(ORA, ZP, 3),
Opcode(ASL, ZP, 5),
Opcode(SLO, ZP, 5),
Opcode(PHP, IMP, 3),
Opcode(ORA, IMM, 2),
Opcode(ASL_A, A, 2),
Opcode(AAC, IMM, 2),
Opcode(TOP, ABS, 4),
Opcode(ORA, ABS, 4),
Opcode(ASL, ABS, 6),
Opcode(SLO, ABS, 6),
Opcode(BPL, REL, 2),
Opcode(ORA, IDIX, 5),
Opcode(KIL, IMP, 0),
Opcode(SLO, IDIX, 8, 0),
Opcode(DOP, ZPX, 4),
Opcode(ORA, ZPX, 4),
Opcode(ASL, ZPX, 6),
Opcode(SLO, ZPX, 6),
Opcode(CLC, IMP, 2),
Opcode(ORA, ABSY, 4),
Opcode(NOP, IMP, 2),
Opcode(SLO, ABSY, 7, 0),
Opcode(TOP, ABSX, 4),
Opcode(ORA, ABSX, 4),
Opcode(ASL, ABSX, 7, 0),
Opcode(SLO, ABSX, 7, 0),
Opcode(JSR, ABS, 6),
Opcode(AND, IXID, 6),
Opcode(KIL, IMP, 0),
Opcode(RLA, IXID, 8),
Opcode(BIT, ZP, 3),
Opcode(AND, ZP, 3),
Opcode(ROL, ZP, 5),
Opcode(RLA, ZP, 5),
Opcode(PLP, IMP, 4),
Opcode(AND, IMM, 2),
Opcode(ROL_A, A, 2),
Opcode(AAC, IMM, 2),
Opcode(BIT, ABS, 4),
Opcode(AND, ABS, 4),
Opcode(ROL, ABS, 6),
Opcode(RLA, ABS, 6),
Opcode(BMI, REL, 2),
Opcode(AND, IDIX, 5),
Opcode(KIL, IMP, 0),
Opcode(RLA, IDIX, 8, 0),
Opcode(DOP, ZPX, 4),
Opcode(AND, ZPX, 4),
Opcode(ROL, ZPX, 6),
Opcode(RLA, ZPX, 6),
Opcode(SEC, IMP, 2),
Opcode(AND, ABSY, 4),
Opcode(NOP, IMP, 2),
Opcode(RLA, ABSY, 7, 0),
Opcode(TOP, ABSX, 4),
Opcode(AND, ABSX, 4),
Opcode(ROL, ABSX, 7, 0),
Opcode(RLA, ABSX, 7, 0),
Opcode(RTI, IMP, 6),
Opcode(EOR, IXID, 6),
Opcode(KIL, IMP, 0),
Opcode(SRE, IXID, 8),
Opcode(DOP, ZP, 3),
Opcode(EOR, ZP, 3),
Opcode(LSR, ZP, 5),
Opcode(SRE, ZP, 5),
Opcode(PHA, IMP, 3),
Opcode(EOR, IMM, 2),
Opcode(LSR_A, A, 2),
Opcode(ASR, IMM, 2),
Opcode(JMP, ABS, 3),
Opcode(EOR, ABS, 4),
Opcode(LSR, ABS, 6),
Opcode(SRE, ABS, 6),
Opcode(BVC, REL, 2),
Opcode(EOR, IDIX, 5),
Opcode(KIL, IMP, 0),
Opcode(SRE, IDIX, 8, 0),
Opcode(DOP, ZPX, 4),
Opcode(EOR, ZPX, 4),
Opcode(LSR, ZPX, 6),
Opcode(SRE, ZPX, 6),
Opcode(CLI, IMP, 2),
Opcode(EOR, ABSY, 4),
Opcode(NOP, IMP, 2),
Opcode(SRE, ABSY, 7, 0),
Opcode(TOP, ABSX, 4),
Opcode(EOR, ABSX, 4),
Opcode(LSR, ABSX, 7, 0),
Opcode(SRE, ABSX, 7, 0),
Opcode(RTS, IMP, 6),
Opcode(ADC, IXID, 6),
Opcode(KIL, IMP, 0),
Opcode(RRA, IXID, 8),
Opcode(DOP, ZP, 3),
Opcode(ADC, ZP, 3),
Opcode(ROR, ZP, 5),
Opcode(RRA, ZP, 5),
Opcode(PLA, IMP, 4),
Opcode(ADC, IMM, 2),
Opcode(ROR_A, A, 2),
Opcode(ARR, IMM, 2),
Opcode(JMP, ABSI, 5),
Opcode(ADC, ABS, 4),
Opcode(ROR, ABS, 6),
Opcode(RRA, ABS, 6),
Opcode(BVS, REL, 2),
Opcode(ADC, IDIX, 5),
Opcode(KIL, IMP, 0),
Opcode(RRA, IDIX, 8, 0),
Opcode(DOP, ZPX, 4),
Opcode(ADC, ZPX, 4),
Opcode(ROR, ZPX, 6),
Opcode(RRA, ZPX, 6),
Opcode(SEI, IMP, 2),
Opcode(ADC, ABSY, 4),
Opcode(NOP, IMP, 2),
Opcode(RRA, ABSY, 7, 0),
Opcode(TOP, ABSX, 4),
Opcode(ADC, ABSX, 4),
Opcode(ROR, ABSX, 7, 0),
Opcode(RRA, ABSX, 7, 0),
Opcode(DOP, IMM, 2),
Opcode(STA, IXID, 6, 0),
Opcode(DOP, IMM, 2),
Opcode(SAX, IXID, 6),
Opcode(STY, ZP_ST, 3),
Opcode(STA, ZP_ST, 3),
Opcode(STX, ZP_ST, 3),
Opcode(SAX, ZP, 3),
Opcode(DEY, IMP, 2),
Opcode(DOP, IMM, 2),
Opcode(TXA, IMP, 2),
Opcode(XAA, IMM, 2),
Opcode(STY, ABS_ST, 4),
Opcode(STA, ABS_ST, 4),
Opcode(STX, ABS_ST, 4),
Opcode(SAX, ABS, 4),
Opcode(BCC, REL, 2),
Opcode(STA, IDIX, 6, 0),
Opcode(KIL, IMP, 0),
Opcode(AXA, IDIX, 6, 0),
Opcode(STY, ZPX, 4),
Opcode(STA, ZPX, 4),
Opcode(STX, ZPY, 4),
Opcode(SAX, ZPY, 4),
Opcode(TYA, IMP, 2),
Opcode(STA, ABSY, 5, 0),
Opcode(TXS, IMP, 2),
Opcode(XAS, ABSY, 5, 0),
Opcode(SYA, ABSX, 5, 0),
Opcode(STA, ABSX, 5, 0),
Opcode(SXA, ABSY, 5, 0),
Opcode(AXA, ABSY, 5, 0),
Opcode(LDY, IMM, 2),
Opcode(LDA, IXID, 6),
Opcode(LDX, IMM, 2),
Opcode(LAX, IXID, 6),
Opcode(LDY, ZP, 3),
Opcode(LDA, ZP, 3),
Opcode(LDX, ZP, 3),
Opcode(LAX, ZP, 3),
Opcode(TAY, IMP, 2),
Opcode(LDA, IMM, 2),
Opcode(TAX, IMP, 2),
Opcode(ATX, IMM, 2),
Opcode(LDY, ABS, 4),
Opcode(LDA, ABS, 4),
Opcode(LDX, ABS, 4),
Opcode(LAX, ABS, 4),
Opcode(BCS, REL, 2),
Opcode(LDA, IDIX, 5),
Opcode(KIL, IMP, 0),
Opcode(LAX, IDIX, 5),
Opcode(LDY, ZPX, 4),
Opcode(LDA, ZPX, 4),
Opcode(LDX, ZPY, 4),
Opcode(LAX, ZPY, 4),
Opcode(CLV, IMP, 2),
Opcode(LDA, ABSY, 4),
Opcode(TSX, IMP, 2),
Opcode(LAR, ABSY, 4),
Opcode(LDY, ABSX, 4),
Opcode(LDA, ABSX, 4),
Opcode(LDX, ABSY, 4),
Opcode(LAX, ABSY, 4),
Opcode(CPY, IMM, 2),
Opcode(CMP, IXID, 6),
Opcode(DOP, IMM, 2),
Opcode(DCP, IXID, 8),
Opcode(CPY, ZP, 3),
Opcode(CMP, ZP, 3),
Opcode(DEC, ZP, 5),
Opcode(DCP, ZP, 5),
Opcode(INY, IMP, 2),
Opcode(CMP, IMM, 2),
Opcode(DEX, IMP, 2),
Opcode(AXS, IMM, 2),
Opcode(CPY, ABS, 4),
Opcode(CMP, ABS, 4),
Opcode(DEC, ABS, 6),
Opcode(DCP, ABS, 6),
Opcode(BNE, REL, 2),
Opcode(CMP, IDIX, 5),
Opcode(KIL, IMP, 0),
Opcode(DCP, IDIX, 8, 0),
Opcode(DOP, ZPX, 4),
Opcode(CMP, ZPX, 4),
Opcode(DEC, ZPX, 6),
Opcode(DCP, ZPX, 6),
Opcode(CLD, IMP, 2),
Opcode(CMP, ABSY, 4),
Opcode(NOP, IMP, 2),
Opcode(DCP, ABSY, 7, 0),
Opcode(TOP, ABSX, 4),
Opcode(CMP, ABSX, 4),
Opcode(DEC, ABSX, 7, 0),
Opcode(DCP, ABSX, 7, 0),
Opcode(CPX, IMM, 2),
Opcode(SBC, IXID, 6),
Opcode(DOP, IMM, 2),
Opcode(ISB, IXID, 8),
Opcode(CPX, ZP, 3),
Opcode(SBC, ZP, 3),
Opcode(INC, ZP, 5),
Opcode(ISB, ZP, 5),
Opcode(INX, IMP, 2),
Opcode(SBC, IMM, 2),
Opcode(NOP, IMP, 2),
Opcode(SBC, IMM, 2),
Opcode(CPX, ABS, 4),
Opcode(SBC, ABS, 4),
Opcode(INC, ABS, 6),
Opcode(ISB, ABS, 6),
Opcode(BEQ, REL, 2),
Opcode(SBC, IDIX, 5),
Opcode(KIL, IMP, 0),
Opcode(ISB, IDIX, 8, 0),
Opcode(DOP, ZPX, 4),
Opcode(SBC, ZPX, 4),
Opcode(INC, ZPX, 6),
Opcode(ISB, ZPX, 6),
Opcode(SED, IMP, 2),
Opcode(SBC, ABSY, 4),
Opcode(NOP, IMP, 2),
Opcode(ISB, ABSY, 7, 0),
Opcode(TOP, ABSX, 4),
Opcode(SBC, ABSX, 4),
Opcode(INC, ABSX, 7, 0),
Opcode(ISB, ABSX, 7, 0),
};

#endif //INSTRUCTION_H
